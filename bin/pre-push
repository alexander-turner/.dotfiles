#!/bin/bash
# Pre-push hook: runs linting checks before pushing
# Mirrors the CI workflow but runs locally for fast feedback

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

echo "Running pre-push checks..."

# Track failures
FAILED=0

# Shellcheck
if command -v shellcheck &> /dev/null; then
    echo -n "Shellcheck: "
    if shellcheck -e SC2016 setup.sh bin/*.sh 2>/dev/null && \
       shellcheck -s bash -e SC2148 -e SC1090 -e SC1091 -e SC2015 .bashrc 2>/dev/null; then
        echo -e "${GREEN}passed${NC}"
    else
        echo -e "${RED}failed${NC}"
        FAILED=1
    fi
else
    echo -e "Shellcheck: ${YELLOW}skipped (not installed)${NC}"
fi

# Fish syntax
if command -v fish &> /dev/null; then
    echo -n "Fish syntax: "
    if find . -name '*.fish' -not -path './apps/fish/functions/_tide*' -exec fish --no-execute {} \; 2>/dev/null; then
        echo -e "${GREEN}passed${NC}"
    else
        echo -e "${RED}failed${NC}"
        FAILED=1
    fi
else
    echo -e "Fish syntax: ${YELLOW}skipped (fish not installed)${NC}"
fi

# StyLua
if command -v stylua &> /dev/null; then
    echo -n "Lua format: "
    if stylua --check . 2>/dev/null; then
        echo -e "${GREEN}passed${NC}"
    else
        echo -e "${RED}failed${NC}"
        FAILED=1
    fi
else
    echo -e "Lua format: ${YELLOW}skipped (stylua not installed)${NC}"
fi

# YAML validation
if command -v yamllint &> /dev/null; then
    echo -n "YAML validation: "
    YAML_FILES=$(find . -name '*.yml' -o -name '*.yaml' | grep -v '.github/' || true)
    if [ -n "$YAML_FILES" ]; then
        if echo "$YAML_FILES" | xargs yamllint -d "{extends: relaxed, rules: {line-length: disable}}" 2>/dev/null; then
            echo -e "${GREEN}passed${NC}"
        else
            echo -e "${RED}failed${NC}"
            FAILED=1
        fi
    else
        echo -e "${GREEN}no files${NC}"
    fi
else
    echo -e "YAML validation: ${YELLOW}skipped (yamllint not installed)${NC}"
fi

# TOML validation
if python3 -c "import toml" 2>/dev/null; then
    echo -n "TOML validation: "
    TOML_FAILED=0
    for f in $(find . -name '*.toml'); do
        if ! python3 -c "import toml; toml.load('$f')" 2>/dev/null; then
            echo -e "${RED}failed${NC} ($f)"
            TOML_FAILED=1
            FAILED=1
            break
        fi
    done
    if [ $TOML_FAILED -eq 0 ]; then
        echo -e "${GREEN}passed${NC}"
    fi
else
    echo -e "TOML validation: ${YELLOW}skipped (python toml not installed)${NC}"
fi

if [ $FAILED -ne 0 ]; then
    echo -e "\n${RED}Pre-push checks failed. Push aborted.${NC}"
    echo "Fix the issues above or use --no-verify to skip (not recommended)."
    exit 1
fi

echo -e "\n${GREEN}All checks passed!${NC}"
